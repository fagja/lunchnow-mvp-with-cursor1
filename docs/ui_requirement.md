# ui_requirement.md

本ドキュメントは「LunchNow」アプリの**UI要件定義書**です。
MVP段階として、エッジケースへの対応はなるべく実装を簡略化し、**基本フローを優先**しています。

**本ドキュメントの主な内容**:
- 画面構成と画面遷移
- 各画面のUI要素と操作方法
- ユーザーインタラクションの詳細
- 表示方法とユーザー体験

**関連ドキュメント**:
- [プロジェクト全体要件](./projectbrief.md): アプリ概要、機能一覧、非機能要件
- [データ要件定義書](./data_requirement.md): データモデル、テーブル構造、運用ルール

---

## 目次

1. [MVPの設計原則](#1-mvpの設計原則)
2. [UI共通コンポーネント](#2-ui共通コンポーネント)
3. [画面構成と遷移](#3-画面構成と遷移)
4. [各画面UI要件](#4-各画面ui要件)
5. [共通仕様](#5-共通仕様)
6. [エラーハンドリング方針](#6-エラーハンドリング方針)
7. [運用ルール](#7-運用ルール)
8. [参照情報](#8-参照情報)

---

## 1. MVPの設計原則

本アプリのMVPでは以下の原則に基づいて設計・実装します：

1. **シンプルさの重視**：基本機能の早期リリースを優先し、複雑な実装は避ける
2. **基本フローの最適化**：主要ユースケースの完成度を優先し、エッジケースは簡略化
3. **開発効率の向上**：共通コンポーネントの活用、最小限のバリデーション
4. **ユーザー体験の一貫性**：エラー表示や画面遷移などの基本動作を統一
5. **パフォーマンス優先**：数値ID採用など、操作の高速化とデータ構造の単純化を実現

MVPの基本方針の詳細については[プロジェクト全体要件の3項](./projectbrief.md#3-mvp設計方針)を参照してください。

この原則に基づき、以下の要素は**MVPでは実装を見送り**ます：
- 複雑なオフライン対応
- 詳細なエラーハンドリング
- リアルタイム更新の高度な最適化
- 複雑なバリデーションロジック
- 高度な装飾やアニメーション
- セキュリティの厳格な実装

---

## 2. UI共通コンポーネント

MVPでは開発効率向上のため、以下の共通UIコンポーネントを利用します。

### 2.1 基本コンポーネント

| コンポーネント名 | 説明 | 用途 |
|--------------|------|-----|
| **Button** | 主要アクション用ボタン | フォーム送信、確認アクション |
| **TextField** | テキスト入力フィールド | ニックネーム入力など |
| **SelectField** | ドロップダウン選択 | 学部、学年などの選択 |
| **Card** | ユーザーカード | ユーザー一覧画面でのユーザー表示 |
| **MessageBubble** | チャットメッセージ | チャット画面でのメッセージ表示 |
| **SimpleMessage** | シンプルなメッセージ表示 | エラーメッセージの表示（単純なdivで実装） |

### 2.2 レイアウトコンポーネント

| コンポーネント名 | 説明 | 用途 |
|--------------|------|-----|
| **PageContainer** | ページレイアウト | 全画面共通のマージン・パディング |
| **Modal** | モーダルダイアログ | 確認ダイアログ、重要通知 |

### 2.3 実装指針

- **Tailwind CSS** を使用して、一貫したデザインとレスポンシブ対応を実現
- **shadcn/ui** のコンポーネントを厳選して使用
- 過度なアニメーションは避け、基本的な状態変化とフィードバックに集中
- コンポーネントは `src/components` ディレクトリに配置し、適切に分類

---

## 3. 画面構成と遷移

### 3.1 ページ構造

```
/
┣ /setup
┣ /users
┗ /chat
```

1. **ルートページ (`/`)**
   - 常に /setup へ自動リダイレクト

### 3.2 画面遷移フロー

1. **`/setup`**
   - 入力完了→サーバー保存成功→`/users`
2. **`/users`**
   - 「とりまランチ？」押下→相互成立→マッチングポップアップ→2秒/OK後`/chat`
   - プロフィール・ステータス編集→`/setup`(その時点での情報をデフォルト表示)
3. **`/chat`**
   - キャンセル押下→ダイアログ→キャンセル完了→`/users`（自動的に募集中状態で表示）
   - メッセージ送信→リアルタイム反映

---

## 4. 各画面UI要件

### 4.1 ランチ設定画面（/setup）

**概要**
- LocalStorageに数値IDが存在する場合は、サーバーからプロフィール情報を取得し、画面にデフォルトとして反映
- プロフィール（ニックネーム・学年・学部）とステータス（空き時間・場所）をまとめて登録・編集する画面
- プロフィールはすべて必須項目、ステータス情報は任意(空欄の場合でもDBは更新)
- 「OK」ボタンでサーバーに **ユーザー情報**を保存し、成功すれば `/users` へ遷移
- ステータスは当日分のみ有効

**プロフィールとステータスの編集方針**:
1. プロフィール情報（ニックネーム・学年・学部）とステータス情報（空き時間・場所）は常に一括で編集
2. 個別編集は実装しない
3. 画面遷移時に現在の値をデフォルト表示し、修正可能とする
4. いずれかの値が変更された場合、すべての情報を一括でサーバーに送信

**UI要素**
1. **画面見出し**
   - 「ランチ設定」を大きめフォント（16px〜18px程度）
2. **プロフィール入力エリア（必須）（画面上部）**
   - **ニックネーム**（1〜12文字、半角全角記号絵文字OK）
   - **学年**（プルダウン）（1〜6年＋その他）
   - **学部**（プルダウン）（文学部 / 経済学部 / 法律学科 / 政治学科 / 商学部 / 医学部 / 理工学部 / 総合政策学部 / 環境情報学部 / 看護医療学部 / 薬学部 / その他）
3. **ステータス入力エリア（任意）（画面中部）**
   - **空き時間 (end_time)(プルダウン)**: ~HH:MM形式 (例：~11:30, ~12:00 など、24時間表記)
       - 現在時刻から最大6時間後（端数切り捨て）まで30分刻みで表示
       - 例: （現在 11:05の場合 → ~11:30, ~12:00, ~12:30 … ~16:00, ~16:30, ~17:00）
       - 選択された値はそのままデータベースに文字列として保存（変換処理不要）
   - **食べたい場所 (place)（プルダウン）**: 学食 / 購買 / キッチンカー / コンビニ / ひよ裏（駅周辺） / 持参（お弁当など） / その他
4. **OKボタン**
   - **既存ユーザー**: サーバーに、該当IDの欄に入力内容を保存
   - **新規ユーザー**: サーバーでIDを自動生成(auto-increment)→入力内容をサーバーに保存、LocalStorageにIDのみ保存
   - 保存成功→ `/users` へ遷移
   - 失敗→エラー表示＋リトライ
5. **バリデーション・エラーメッセージ**
   - 「OKボタン押下時」に一括チェック

**LocalStorageの利用方針**:

1. **保存対象**: ユーザーIDのみをLocalStorageに保存し、その他の情報は都度サーバーから取得
2. **キー名**: 'lunchnow_user_id' など、一貫したキー名を使用
3. **初回アクセス時**: ユーザーIDが存在しない場合は `/setup` 画面でプロフィール入力後、サーバーが生成したIDを保存
4. **再アクセス時**: LocalStorageからIDを取得し、サーバーからプロフィール情報を読み込む
5. **エラー処理**: LocalStorage取得エラーやIDが無効な場合は、新規ユーザーとして扱い `/setup` に誘導

### 4.2 ユーザー一覧画面（`/users`）

**概要**
- **未マッチ**のユーザー（自分は除く）かつ最近20分以内に募集開始したユーザーを一覧表示
- 「最新更新日時順」で上に来るよう並べる
- 1ユーザー1マッチルール
- 相互Likeでマッチ成立→両者の「未マッチ」状態はマッチ状態（is_matched=true）に→マッチ成立ポップアップ→`/chat`へ
- Likeやマッチは当日分のみ有効

**UI要素**
1. **プロフィール・ステータス編集ボタン** (画面左上)
   - 押下で `/setup` に移動
   - 編集完了後、'/users'に遷移
2. **手動リロードボタン** (画面上右)
   - 押下でユーザー一覧の最新データを再取得
3. **募集状態説明テキスト** (画面上中央)
   - 「募集状態は20分間有効です」
   - 「20分経過した場合、再度ランチ設定画面に戻り、再設定してください」
4. **ユーザーカード一覧**
   - 表示要素: ニックネーム、学年と学部（「3年 商学部」形式）、`~HH:MM`（end_time）、場所
   - 各カードには自分がLike済みかどうかを示す視覚的な表示
5. **「とりまランチ？」(like)ボタン**
   - ボタンクリック→ `likes` にINSERT → 相互Like確認 → 成立なら `matches` 作成→ ポップアップ→ `/chat` へ
6. **マッチング成立ポップアップ**
   - Like送信時のレスポンスでマッチが確認できた場合に表示 (2秒経過 or OK押下後 `/chat`へ)

**API連携**
- **最適化された募集中ユーザー一覧API** (`/api/users/recruiting?current_user_id=123`)を使用
- レスポンスには `liked_by_me` フラグが含まれ、追加APIコールなしでLike状態を表示可能
- 日時データは表示用フォーマット済みで、クライアント側での変換が不要

**ユーザビリティ対応**
- **ローディング状態**: データ取得中はシンプルなローディングスピナーを表示
- **空の状態**: 未マッチかつ20分以内に募集を開始したユーザーがいない場合は「現在募集中のユーザーはいません。また後で確認してください。」というメッセージを表示
- **リフレッシュ表示**: 手動リロードボタンの近くに「最終更新: XX:XX」を表示

### 4.3 チャット画面（`/chat`）

**概要**
- マッチ成立したユーザー同士の1対1チャット
- メッセージ送信は最大200文字、文字種は半角・全角OK（記号・絵文字OK）
- マッチキャンセル可能→キャンセルしたら両者`is_matched=false`に戻す
- **3秒間隔の自動ポーリングでメッセージを取得**（画面遷移時やバックグラウンド時は自動停止）

**UI要素**
1. **相手のニックネーム・学年学部** (画面上左)
   - ニックネームを上段、学年学部を下段に表示
   - 他のチャットアプリと同様の標準的なレイアウト

2. **マッチキャンセルボタン** (画面上右)
   - 「本当にキャンセルしますか？」確認ダイアログ表示
   - OKの場合、サーバーで `matches.is_canceled` をtrueに更新
   - 両ユーザーを is_matched = false にして recruiting_since を現在時刻に更新
   - 相互のLikeをlikesテーブルから削除 （当事者間の即時再マッチ防止のため）（当事者間の再マッチングには再度相互Likeが必要）
   - **キャンセルしたユーザー** → `/users` へ移動（自動的に未マッチ状態で表示）
   - **キャンセルされたユーザー** → 「相手がキャンセルしました」ポップアップ→2秒 or OK押下で `/users`へ
   - 両ユーザーはすぐに新しいマッチングを試みることができる

3. **メッセージ一覧エリア**
   - 下から上にスクロール
   - 送信者によって吹き出しを左右分けるなど
   - 新しいメッセージは自動的に画面下部に表示される
   - **初期ロード時**: 過去のメッセージ履歴を通常APIで一度だけ読み込み表示
   - **新規メッセージ**:
     - 3秒ごとのポーリングで新規メッセージを確認・取得
     - 接続エラー時は通常のエラーメッセージを表示
     - 画面遷移時やバックグラウンド時は自動的にポーリングを停止

4. **メッセージ入力フォーム** (画面下)
   - テキストボックス + 「送信」ボタン
   - **モバイルでのEnterキー**は改行のみ。送信は画面上のボタン押下時
   - 送信成功/失敗のみを表示（「送信中」インジケーターなし）
   - 送信処理はトランザクション型（失敗時に再送可能）

**画面レイアウト概要**
```
+----------------------------------+
| [ニックネーム]          [キャンセル] |
| [学年 学部]                      |
+----------------------------------+
|                                  |
|       メッセージ一覧エリア          |
|                                  |
+----------------------------------+
|       メッセージ入力フォーム        |
+----------------------------------+
```

**パフォーマンス最適化**
- 3秒間隔の自動ポーリングによりリアルタイム性と開発の簡素化を両立
- 画面遷移時やバックグラウンド時にポーリングを停止してリソース消費を抑制
- 初期表示時に最新メッセージを一括表示（ページング機能はMVP後に検討）

---

## 5. 共通仕様

### 5.1 バリデーション

- **MVPではクライアント側バリデーションのみ実装**
- HTML標準属性（required, maxlength）のみを使用
- ブラウザ標準のバリデーション機能とエラー表示を活用
- フォーム送信時（OKボタン押下時）にブラウザが自動的にチェック
- 将来的なセキュリティ強化フェーズ（MVP後）でサーバー側バリデーションを追加予定

**バリデーション実装詳細**:

1. **HTML標準属性のみを使用**:
   - `required`属性: 必須項目に適用
   - `maxlength`属性: 文字数制限に適用（例: ニックネームは12文字まで）
   - `pattern`属性: 必要最小限の場合のみ使用（基本的には回避）

2. **ブラウザ標準のエラー表示を利用**:
   - ブラウザのデフォルトエラーメッセージをそのまま使用
   - カスタムバリデーションロジックやエラーメッセージは実装しない

3. **シンプルな実装例**:
   ```html
   <input
     type="text"
     name="nickname"
     required
     maxlength="12"
     className="input-field"
   />
   ```

### 5.2 レスポンシブ対応

- **モバイルファースト**: モバイル画面（375px〜414px）を基本デザインとして実装
- **ブレイクポイント**:
  - スマートフォン: 375px〜767px
  - タブレット: 768px〜1023px
  - デスクトップ: 1024px以上
- **タッチターゲット**: モバイルでのタップ操作を考慮し、ボタンなどのサイズは最低44px×44pxを確保

### 5.3 アクセシビリティ対応

MVPでは実装が複雑にならない範囲で、以下の最小限のアクセシビリティのみ対応します:

- **色のコントラスト**: テキストと背景のコントラスト比は少なくとも4.5:1を確保（Tailwind CSSの標準カラーパレットを活用）
- **フォームラベル**: すべての入力フィールドには関連するラベルを提供

※キーボード操作など実装が複雑になりうる対応はMVP後の改善とします。shadcn/uiコンポーネントの標準機能として提供されるアクセシビリティ対応は活用します。

### 5.4 ポップアップ表示

- 基本的にポップアップはポップアップ内容とOKボタン、最大2秒表示
- 2秒経過、もしくはOKボタン押下時にポップアップ消滅または画面遷移

### 5.5 スマホ戻るボタン対応

- **MVP簡略化**: 端末の戻る操作はそのまま前ページに戻す
- 再表示時にサーバー状態を都度確認し、不整合あれば適宜 `/users` or `/setup` へリダイレクト

---

## 6. エラーハンドリング方針

MVPでは、実装の容易さを最優先し、最小限のエラーハンドリングのみを実装します。

### 6.1 基本方針

MVPでは極限までシンプルなエラーハンドリングを採用します:

1. **フォームバリデーション**:
   - HTML標準のバリデーション機能とブラウザデフォルトのエラー表示のみを使用
   - カスタムバリデーションは一切実装しない

2. **API通信エラー**:
   - `try/catch`ブロックと単一のエラーメッセージ表示のみ
   - 「通信エラーが発生しました。再試行してください。」という汎用メッセージを使用

3. **UI実装の簡素化**:
   - 複雑なトースト通知やモーダルは使用せず、単純なHTMLの`alert()`またはシンプルなメッセージ表示のみ
   - エラー表示用のカスタムコンポーネントは作成しない

### 6.2 実装例

```typescript
// 最小限のエラーハンドリング実装例
try {
  // API呼び出しなど
  await api.saveUser(userData);
  // 成功時は単に次画面に進む（成功メッセージなし）
  router.push('/users');
} catch (error) {
  // 単一のエラーメッセージを表示
  alert("通信エラーが発生しました。再試行してください。");
  // またはシンプルなHTMLメッセージ
  setErrorMessage("通信エラーが発生しました。再試行してください。");
}
```

### 6.3 フォームバリデーション

フォームバリデーションについては、[5.1項 バリデーション](#51-バリデーション)を参照してください。詳細なバリデーション戦略は統一されており、HTML標準属性とブラウザのデフォルト機能のみを使用します。

### 6.4 オフライン対応

MVPでは複雑なオフライン対応は行わず、以下の最小限の対応のみとします：

- 操作失敗時に単純なエラーメッセージを表示
- 再試行は手動リロードボタンのみで対応
- オフライン状態の自動検知や対応は実装しない

### 6.5 将来的な拡張

MVP後の改善フェーズでは、以下の拡張を検討します：

- よりユーザーフレンドリーなエラーメッセージ
- エラー種別に応じた適切なガイダンス
- リアルタイムバリデーション
- オフライン状態の自動検知と適切な対応

---

## 7. 運用ルール

### 7.1 ゴーストユーザー対策

**概要**
- ゴーストユーザー対策の詳細ロジックについては[データ要件定義書の3.1項](./data_requirement.md#31-募集中状態管理)を参照してください。

**UI上の対応**
- ユーザー一覧画面に明確な説明テキストを表示：「募集状態は20分間有効です」「20分経過した場合、再度ランチ設定画面に戻り、再設定してください」
- ユーザー一覧画面では手動リロードボタンで最新状態を取得
- 20分以上経過したユーザーは、リロード時に一覧から自動的に除外

### 7.2 データベース設計の主要方針

MVPでは以下のデータベース設計方針を採用しています：

1. **数値ID (auto-increment)の採用**
   - パフォーマンスと開発効率を向上（詳細な理由は[データ要件定義書](./data_requirement.md#73-数値id採用の理由)を参照）
   - ユーザーIDやマッチIDなど、すべての主キーに数値IDを使用

2. **シンプルなデータモデル**
   - ユーザープロフィールとステータス情報を単一テーブルで管理
   - 最小限のテーブルと単純なリレーションシップでMVPを実現
   - 詳細なデータ構造は[データ要件定義書](./data_requirement.md#2-テーブル仕様)を参照

---

## 8. 参照情報

- [Tailwind CSS ドキュメント](https://tailwindcss.com/docs)
- [Next.js App Router ドキュメント](https://nextjs.org/docs/app)

---

## まとめ

本ドキュメントはあくまでMVP実装の**最小限UI要件**を定義しています。
将来的に機能拡張やセキュリティ強化を行う際は、このドキュメントをベースに追加要件を追記してください。
