# マッチング成立とチャット機能テスト

## 概要
このファイルではマッチング成立後のチャット機能の統合テストケースを定義します。

## 前提条件
- テスト環境: ローカル開発環境（Supabase CLI起動済み）
- ブラウザ: Chrome
- 少なくとも2名のテストユーザーがすでに登録されている
- テストユーザー1とテストユーザー2がマッチング成立している状態

## テストケース

### TC-01: チャット画面の基本表示
**目的**: マッチング成立後のチャット画面が適切に表示されることを確認する

**手順**:
1. テストユーザー1とテストユーザー2がマッチング成立した状態で、両者がチャット画面(/chat)に遷移
2. 相手のニックネーム・学年学部の表示を確認
3. マッチキャンセルボタンの表示を確認
4. メッセージ入力フォームの表示を確認

**期待結果**:
- チャット画面の上部に相手のニックネームと学年学部が表示される
- 右上にマッチキャンセルボタンが表示される
- 下部にメッセージ入力フォームと送信ボタンが表示される
- 初期状態ではメッセージがなく、空の状態であることが適切に表示される

**実行結果**:
- [-] 成功
- [ ] 失敗
  - 失敗内容:

### TC-02: メッセージ送受信機能
**目的**: チャットメッセージが正常に送信・表示されることを確認する

**手順**:
1. テストユーザー1のチャット画面でメッセージ「こんにちは、ランチどこにしますか？」を入力して送信
2. テストユーザー2の画面でのメッセージ表示を確認
3. テストユーザー2からメッセージ「学食はどうですか？」を送信
4. テストユーザー1の画面でのメッセージ表示を確認
5. 複数メッセージを連続して送信し、表示を確認

**期待結果**:
- 送信したメッセージがDB内のmessagesテーブルに保存される
- 送信者と受信者の両方の画面に適切なフォーマットでメッセージが表示される
- 送信者と受信者のメッセージが視覚的に区別できる（左右配置など）
- 各メッセージには送信時刻が表示される
- ポーリングにより、相手の送信したメッセージが約3秒以内に自動的に表示される

**実行結果**:
- [ ] 成功
- [ ] 失敗
  - 失敗内容:

### TC-03: マッチキャンセル機能
**目的**: マッチキャンセル機能が正常に動作することを確認する

**手順**:
1. テストユーザー1のチャット画面でマッチキャンセルボタンをクリック
2. 「本当にキャンセルしますか？」確認ダイアログが表示されることを確認
3. 「キャンセル」（否定）ボタンをクリックしてダイアログを閉じる
4. 再度マッチキャンセルボタンをクリックし、今度は「OK」（肯定）ボタンをクリック

**期待結果**:
- 「キャンセル」ボタンクリック時はダイアログが閉じるだけで、マッチ状態は維持される
- 「OK」ボタンクリック時は以下の動作が行われる:
  - DB内のmatchesテーブルでis_canceledがtrueに更新される
  - 両ユーザーのis_matchedがfalseに更新される
  - 両ユーザーのrecruiting_sinceが現在時刻に更新される
  - 両ユーザー間のLikeレコードがlikesテーブルから削除される
  - キャンセルしたユーザー（テストユーザー1）は/usersページに自動遷移する

**実行結果**:
- [ ] 成功
- [ ] 失敗
  - 失敗内容:

### TC-04: キャンセルされた側のユーザー表示
**目的**: マッチキャンセル時に相手側に適切な通知が表示されることを確認する

**手順**:
1. テストユーザー1とテストユーザー3が新たにマッチした状態を用意
2. テストユーザー1がマッチキャンセルを実行
3. テストユーザー3の画面表示を確認

**期待結果**:
- テストユーザー3の画面に「相手がキャンセルしました」というポップアップが表示される
- ポップアップ表示後、約2秒後または「OK」ボタン押下で/usersページに自動遷移する
- テストユーザー3も募集中状態（is_matched=false）に戻り、/users画面で他のユーザーが表示される

**実行結果**:
- [ ] 成功
- [ ] 失敗
  - 失敗内容:

### TC-06: バックグラウンドポーリング動作
**目的**: チャットのポーリングがバックグラウンド時に適切に動作することを確認する

**手順**:
1. テストユーザー1とテストユーザー2がマッチング済みでチャット画面を表示中
2. テストユーザー1のブラウザタブを非アクティブ（バックグラウンド）にする
3. テストユーザー2からメッセージを送信
4. 10秒待機
5. テストユーザー1のブラウザタブをアクティブに戻す

**期待結果**:
- テストユーザー1のブラウザタブがバックグラウンドの間はポーリングが停止する
- ブラウザタブをアクティブに戻すとポーリングが再開し、テストユーザー2が送信したメッセージが表示される

**実行結果**:
- [ ] 成功
- [ ] 失敗
  - 失敗内容:

### TC-07: メッセージの文字数制限
**目的**: メッセージの文字数制限が適切に機能することを確認する

**手順**:
1. テストユーザー1のチャット画面で、201文字以上のメッセージを入力
2. 送信ボタンをクリック

**期待結果**:
- 200文字を超えるメッセージは送信できないようバリデーションが働く
- エラーメッセージが表示される、または入力欄で200文字までしか入力できない

**実行結果**:
- [ ] 成功
- [ ] 失敗
  - 失敗内容:

### TC-08: エラーハンドリング
**目的**: ネットワークエラーやサーバーエラー時の動作を確認する

**手順**:
1. テストユーザー1とテストユーザー2がマッチング済みでチャット画面を表示中
2. テストユーザー1のネットワーク接続を意図的に切断（開発ツールのネットワークタブで「オフライン」を選択）
3. メッセージを入力して送信を試みる
4. ネットワーク接続を復旧
5. 再度送信を試みる

**期待結果**:
- ネットワークエラー時に適切なエラーメッセージが表示される
- 接続復旧後の送信は正常に機能する
- 接続が復旧するとポーリングも自動的に再開される

**実行結果**:
- [ ] 成功
- [ ] 失敗
  - 失敗内容:
